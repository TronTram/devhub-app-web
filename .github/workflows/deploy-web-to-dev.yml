name: On Deployment Created
on: 
  deployment
env:
  PULL_NUMBER: ${{ github.event.deployment.payload.pr }}
  MICRO_SERVICE: ${{ github.event.deployment.payload.microservice }}
  DEPLOY_REF: ${{ github.event.deployment.ref }}
  DEPLOYMENT_ID: ${{ github.event.deployment.id }}
  ENVIRONMENT: ${{ github.event.deployment.environment }}
  INFRA_NAME: devhub-app-web
  SUFFIX: "-${{ github.event.deployment.payload.pr }}"
jobs:
  build:
    if: ${{ github.event.deployment.payload.microservice == 'web' }}
    name: Build and Deploy Gatsby
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v1
      
      - name: Change Deploy Status to Pending
        uses: actions/github-script@0.3.0
        with:
          github-token: ${{github.token}}
          script: |
            github.repos.createDeploymentStatus({
              deployment_id: context.payload.deployment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'pending'
            });
      - name: Cluster Login
        uses: redhat-developer/openshift-actions@v1.1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL}}
          parameters: '{"apitoken": "${{ secrets.SA_PASSWORD }}"}'
          cmd: |
            'version'
      - name: Cancel previous builds (if any)
        run: 'oc cancel-build -n ${{ env.TOOLS_NAMESPACE }} bc/${{ env.INFRA_NAME }}${{ env.SUFFIX }} || no build found for ${{ github.event.deployment.payload.pr }}'
      - name: Run Build
        env:
          TOOLS_NAMESPACE: ${{ secrets.TOOLS_NAMESPACE }}
          GATSBY_MATOMO_URL: ${{ secrets.GATSBY_MATOMO_URL }}
          GATSBY_MATOMO_SITE_URL: ${{ secrets.GATSBY_MATOMO_SITE_URL }}
          GATSBY_MATOMO_SITE_ID: ${{ secrets.GATSBY_MATOMO_SITE_ID }}

        run: |
          oc process -f openshift/templates/web/bc.yaml -n $TOOLS_NAMESPACE \
          -p SUFFIX=$SUFFIX \
          -p SOURCE_REPOSITORY_URL="https://github.com/$GITHUB_REPOSITORY" \
          -p SOURCE_REPOSITORY_REF=$GITHUB_REF \
          -p MATOMO_URL=$GATSBY_MATOMO_URL \
          -p NAME=$INFRA_NAME \
          -p MATOMO_SITE_URL=$GATSBY_MATOMO_SITE_URL \
          -p MATOMO_SITE_ID=$GATSBY_MATOMO_SITE_ID -n $TOOLS_NAMESPACE \
          -p VERSION="$PULL_NUMBER" | \
          oc apply -n $TOOLS_NAMESPACE -f -
          echo "Build started"
          oc start-build -n $TOOLS_NAMESPACE $INFRA_NAME$SUFFIX --wait
